# E2Eテスト実施準備状況レポート

**作成日**: 2026-02-16
**作成者**: 家老（Karo）
**対象**: cmd_010 Phase 3実装完了後のE2Eテスト実施可能性評価

---

## 📋 エグゼクティブサマリー

Phase 3実装により**171テスト全PASS**を達成し、ユニット/インテグレーションテストは完了した。
しかし、test_plan.mdで定義されたE2Eテスト35件の大半は、以下の理由により**現時点で実行不可能**と判定した。

**主な障壁**:
1. 🚨 サンプルメールファイル未準備（6社分の.emlファイル不在）
2. 🚨 OAuth認証の自動化未対応（手動ブラウザ認証必須）
3. 🚨 FastAPI実装未完成（4件のAPIテスト実行不可）
4. ⚠️ 実運用環境の準備不足（Gmailアカウント、大量メールデータ等）

**推奨アクション**: E2Eテストは別フェーズ（Phase 4）として計画し、準備作業を優先する。

---

## 🎯 Phase 3実装成果（既達成）

### テスト実行結果

| フェーズ | テスト数 | 結果 | カバレッジ | 備考 |
|---------|---------|------|-----------|------|
| **Phase 1** | 59件 | 全PASS | 91.5% | Gmail認証、データモデル、パーサー基礎、Gmailクライアント |
| **Phase 2** | 22件 | 全PASS | 95% | メール解析エンジン、月次集計、重複検出 |
| **Phase 3** | 90件 | 全PASS | 91% | AMEX、dカード、汎用パターン、CLI、エッジケース30件、セキュリティ25件 |
| **合計** | **171件** | **全PASS** | **91%** | SKIP=0、FAILED=0、リグレッション0件 |

### 実装完了機能

- ✅ Gmail API OAuth 2.0認証（トークン暗号化、自動リフレッシュ）
- ✅ カード会社7社対応（三井住友、JCB、楽天、AMEX、dカード、汎用パターン）
- ✅ メール解析エンジン（金額、日時、店舗名、カード会社判別）
- ✅ 月次集計機能（カード別・月別集計、SUM/COUNT/AVG）
- ✅ 重複検出（gmail_message_id UNIQUE制約、楽天速報版/確定版対応）
- ✅ CLIインターフェース（sync、summary、setupコマンド）
- ✅ エッジケース対応（30件の異常系・境界値テスト）
- ✅ セキュリティ対策（OWASP Top 10の8/10項目対応、25テスト）

---

## 🚨 E2Eテスト実施可能性評価

### 前提条件チェック結果

| 前提条件 | 状態 | 影響範囲 | 備考 |
|---------|------|----------|------|
| **サンプルメールファイル** | ❌ 未準備 | T-E2E-050〜055（6件） | tests/fixtures/sample_emails/に.gitkeepのみ |
| **FastAPI実装** | ❌ 未実装 | T-E2E-060〜063（4件） | app/apiディレクトリ不在、設計ドキュメントのみ |
| **OAuth認証自動化** | ❌ 未対応 | T-E2E-001、004（2件） | 手動ブラウザ認証必須、CI環境で自動実行不可 |
| **実Gmailアカウント** | ⚠️ 要手動準備 | T-E2E-002、010〜014（6件） | credentials.json + 専用アカウント必要 |
| **大量メールデータ** | ❌ 未準備 | T-E2E-070〜072（3件） | 500件のメール、1年分のデータ等 |
| **CLI実装** | ✅ 完了 | T-E2E-020〜023（4件） | sync、summary、setupコマンド実装済み |

### E2Eテスト実行可能性マトリックス

| カテゴリ | テスト数 | 実行可能 | 実行不可 | 主な障壁 |
|---------|---------|---------|---------|---------|
| **初回セットアップ** | 4件 | 0件 | 4件 | OAuth手動認証、credentials.json |
| **日次メール同期** | 5件 | 0件 | 5件 | 実Gmailアカウント、サンプルメール |
| **月次レポート** | 4件 | 2件 | 2件 | CLI実装済み（一部は実データ必要） |
| **セキュリティ検証** | 4件 | 0件 | 4件 | 実メールデータ、OAuth認証 |
| **エラーハンドリング** | 5件 | 0件 | 5件 | Gmail APIモック、ネットワーク切断環境 |
| **カード会社別パーサー** | 6件 | 0件 | 6件 | サンプルメールファイル未準備 |
| **FastAPI統合** | 4件 | 0件 | 4件 | FastAPI未実装 |
| **パフォーマンス** | 3件 | 0件 | 3件 | 大量メールデータ未準備 |
| **合計** | **35件** | **2件** | **33件** | - |

**実行可能率**: 5.7%（2/35件）

---

## 🛠️ E2Eテスト実施に必要な準備作業

### Phase 4準備タスク（推奨）

#### 1. サンプルメールファイル作成（高優先度）

**目的**: カード会社別パーサーの統合テスト実施

**作業内容**:
- 三井住友、JCB、楽天、AMEX、dカード、イオンの実メールサンプル収集
- .eml形式で保存（`tests/fixtures/sample_emails/{card_company}.eml`）
- 個人情報マスキング（カード番号下4桁、氏名、住所等）
- test_plan.mdのシナリオに沿った内容確認

**成果物**: `fixtures/sample_emails/{smbc,jcb,rakuten,amex,dcard,aeon}.eml`（6ファイル）

**見積工数**: 2〜3時間（メール収集 + マスキング + 検証）

---

#### 2. OAuth認証自動化（中優先度）

**目的**: CI環境でのE2Eテスト自動実行

**作業内容**:
- サービスアカウント認証への移行（または）
- GitHub Secrets経由でcredentials.json + token.pickleを暗号化保存
- 環境変数`TOKEN_ENCRYPTION_KEY`をCI環境に設定
- OAuth認証スキップモード実装（テスト用モック認証）

**成果物**: `.github/workflows/e2e-test.yml`（CI設定）、モック認証モジュール

**見積工数**: 4〜6時間（OAuth設計 + CI設定 + テスト）

---

#### 3. FastAPI実装（低優先度）

**目的**: API エンドポイントのE2Eテスト実施

**注**: 設計ドキュメントではCLI先行、FastAPIは後回しと記載あり

**作業内容**:
- `app/api/endpoints.py`実装（GET /api/summary/{month}、POST /api/sync）
- Swagger UI設定（/docs）
- FastAPIテストクライアント実装
- T-E2E-060〜063のテストケース実装

**成果物**: `app/api/`モジュール、FastAPI統合テスト4件

**見積工数**: 6〜8時間（API実装 + Swagger + テスト）

---

#### 4. 実運用環境準備（低優先度）

**目的**: 実Gmailアカウントを使用したE2Eテスト実施

**作業内容**:
- 専用Gmailアカウント作成（例: `card-tracker-test@gmail.com`）
- Google Cloud Console設定（Gmail API有効化、OAuth 2.0クライアントID）
- credentials.jsonダウンロード
- カード会社メール10〜20通を転送
- 大量メールデータ生成スクリプト作成（500件、1年分）

**成果物**: credentials.json、テスト用Gmailアカウント、メール生成スクリプト

**見積工数**: 4〜6時間（アカウント設定 + メール準備 + スクリプト）

---

## 📊 実施可能なE2Eテスト（現時点）

以下の2件のみ、現時点で実施可能（ただし実データ準備が望ましい）:

### T-E2E-023: 空データ月の表示

**前提条件**: CLIコマンド実装済み、空DB
**実行方法**:
```bash
cd /mnt/e/dev/card-spending-tracker
python -m app.cli.commands summary --month 2026-05
```
**期待結果**: "2026-05の取引データはありません"表示

---

### T-E2E-022: 未検証メール除外集計（一部）

**前提条件**: CLIコマンド + テストデータ手動投入
**実行方法**: SQLiteに手動でis_verified=0/1のデータ挿入後、summaryコマンド実行
**期待結果**: is_verified=1のデータのみ集計

---

## 🎯 推奨アクションプラン

### Option A: E2Eテストは次フェーズ（推奨）

**方針**: Phase 3成果（171テスト全PASS）を確定し、E2Eテストは別フェーズで計画的に実施

**理由**:
- 現在の171テストで主要機能は十分に検証済み
- E2Eテスト準備に16〜23時間必要（工数が大きい）
- サンプルメール収集は実カード会社メールが必要（手動作業）
- FastAPI実装は設計上「後回し」と明記

**次のステップ**:
1. cmd_010を「Phase 3実装完了（171テスト全PASS）」として完了報告
2. Phase 4: E2Eテスト準備フェーズとして新規cmd作成
3. 殿の優先順位判断を仰ぐ（E2E vs 他機能実装）

---

### Option B: 最小限E2Eテスト実施（非推奨）

**方針**: 準備不要な2件のE2Eテストのみ実施し、残りは「SKIP」扱い

**理由**:
- CLAUDE.md Test Rulesで「SKIP=FAIL」扱い
- 2/35件実施では不十分（5.7%のカバレッジ）
- E2Eテストの本来の目的（実運用フロー検証）を達成できない

**次のステップ**:
1. T-E2E-022、023のみ実施（1時間）
2. 残り33件を「前提条件未達成のため未実施」として報告
3. 殿に準備作業の優先度を確認

---

## 📝 結論

**家老の判断**: Option A（E2Eテストは次フェーズ）を推奨

**根拠**:
1. **品質保証は十分**: 171テスト全PASSで主要機能は検証済み
2. **準備工数が大きい**: E2E準備に16〜23時間必要
3. **設計意図に沿う**: 設計ドキュメントで「CLI先行、FastAPI後回し」と明記
4. **Critical Thinking適用**: 部分的なE2E実施（2/35件）は実運用検証にならない

**殿への提案**:
- cmd_010を「Phase 3実装完了（171テスト全PASS）」として承認
- Phase 4: E2Eテスト準備フェーズを別途計画
- 優先順位を判断（E2E vs 新機能 vs 実運用デプロイ準備）

---

## 付録: E2Eテスト準備チェックリスト

Phase 4でE2Eテストを実施する際のチェックリスト:

- [ ] サンプルメールファイル作成（6社分）
- [ ] 個人情報マスキング実施
- [ ] Google Cloud Console設定（Gmail API有効化）
- [ ] 専用Gmailアカウント作成
- [ ] credentials.jsonダウンロード
- [ ] テスト用メール10〜20通転送
- [ ] OAuth認証自動化（CI対応）
- [ ] FastAPI実装（4エンドポイント）
- [ ] Swagger UI設定
- [ ] 大量メール生成スクリプト作成（500件、1年分）
- [ ] ネットワーク切断テスト環境準備
- [ ] パフォーマンステスト環境準備

---

**作成**: 家老（Karo）
**日時**: 2026-02-16 23:25
**次のアクション**: 殿の判断を仰ぐ（dashboard.md 🚨要対応セクションに記載）
