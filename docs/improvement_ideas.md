# card-spending-tracker 改善案一覧

> 収集日: 2026-02-20 | エージェント: 足軽1-8号 + 軍師 | 総件数: 55件

## カテゴリ別サマリー

| カテゴリ | 件数 | 高 | 中 | 低 |
|----------|------|----|----|----|
| UI/UX改善 | 5件 | 0 | 2 | 3 |
| 通知・アラート機能 | 5件 | 1 | 2 | 2 |
| データ可視化・分析 | 6件 | 0 | 2 | 4 |
| カード対応拡充 | 6件 | 2 | 4 | 0 |
| コード品質・テスト強化 | 10件 | 0 | 4 | 6 |
| 運用・ドキュメント | 5件 | 0 | 1 | 4 |
| AI・高度技術機能 | 6件 | 3 | 3 | 0 |
| セキュリティ・プライバシー | 5件 | 0 | 2 | 3 |
| 戦略・アーキテクチャ（軍師） | 7件 | 1 | 3 | 3 |
| **合計** | **55件** | **7** | **23** | **25** |

---

## UI/UX改善

### A1-001: 月次支出推移グラフ（月次集計画面）
- **概要**: summary.html は現状テーブルのみ。直近6〜12ヶ月の支出推移を横棒グラフまたは折れ線グラフで可視化し、月ごとの増減を一目で把握できるようにする。Chart.js（CDN）または CSS-only バーで実装可能。
- **期待効果**: 「先月より使いすぎか」を数字を読まずに直感的に判断できる。支出トレンドの把握が数秒で可能になり、節約行動のきっかけになる。
- **難易度**: 中
- **提案元**: 足軽1号
- **対象画面**: 月次集計（/summary）

### A1-002: フリーワード検索フィールド（取引一覧画面）
- **概要**: transactions.html の filter-bar に「店舗名キーワード」テキスト入力欄を追加。htmx の hx-get + hx-trigger="input delay:300ms" で入力するたびにリアルタイムフィルタリングを行う。
- **期待効果**: 「コンビニ」「Amazon」など店舗名で絞り込めるようになり、特定支出の確認や重複チェックが格段に速くなる。月・カードフィルタとの組み合わせも可能。
- **難易度**: 低
- **提案元**: 足軽1号
- **対象画面**: 取引一覧（/transactions）

### A1-003: テーブルヘッダークリックソート（取引一覧）
- **概要**: transaction_table.html の日付・金額・カード列ヘッダをクリックで昇順/降順ソートできるようにする。現在の sort_by / sort_order クエリパラメータを htmx で送信する方式。
- **期待効果**: 「高額順で並べて無駄遣いを確認」「古い順から追いたい」などの操作が1クリックで可能になり、データ分析効率が向上する。
- **難易度**: 中
- **提案元**: 足軽1号
- **対象画面**: 取引一覧（/transactions）

### A1-004: 取引CSVエクスポートボタン（取引一覧）
- **概要**: 取引一覧画面に「CSVダウンロード」ボタンを追加し、現在適用中のフィルタ（月・カード・キーワード）で絞り込まれた取引データをCSVとしてダウンロードできるようにする。
- **期待効果**: Excelや家計簿アプリへのデータ連携が容易になる。月次レポートを手動で作成したい場合にも有用。殿が外部ツールで追加分析できる柔軟性が生まれる。
- **難易度**: 低
- **提案元**: 足軽1号
- **対象画面**: 取引一覧（/transactions）
- **関連案**: A3-005（CSVエクスポートAPI実装）、G-003（エクスポート基盤戦略）

### A1-005: スマートフォン用ハンバーガーメニュー（ナビゲーション）
- **概要**: 現状のモバイルナビは横リストがそのまま折り返す形で画面幅を圧迫する。ハンバーガーアイコン（☰）クリックで開閉するドロワーメニューに変更する。JavaScriptは数行（class toggle）のみ、外部ライブラリ不要。
- **期待効果**: スマートフォンでコンテンツ閲覧エリアが広がり、片手操作でのナビゲーションが快適になる。特に取引一覧・月次集計画面でのテーブル閲覧体験が改善する。
- **難易度**: 低
- **提案元**: 足軽1号
- **対象画面**: 全画面（base.html）

---

## 通知・アラート機能

### A2-001: カテゴリ別月次予算管理アラート
- **概要**: 食費・交通費・娯楽費・サブスク等のカテゴリタグを取引に付与し、カテゴリごとに月間予算上限を設定。80%到達・100%超過時に段階的ntfy通知。
- **期待効果**: 「今月の外食費が予算に近い」と事前把握でき、月末に支出超過する前に行動変容できる。全体しきい値では気づけないカテゴリ単位の無駄遣いを可視化。
- **難易度**: 中
- **提案元**: 足軽2号

### A2-002: 定期支出・サブスク自動検知と月初通知
- **概要**: 同一業者から一定周期（28〜32日）で同額の支出パターンをDBから自動検知し、サブスクリスト（業者名・金額・次回予定日）を自動生成。月初1日にntfy通知。
- **期待効果**: 「いつの間にか使っているサブスク」を網羅的に把握でき、不要なサービスの解約漏れを防ぐ。月初に「今月予想サブスク合計：○○円」を把握することで固定費管理が可能になる。
- **難易度**: 中
- **提案元**: 足軽2号

### A2-003: 支出ベロシティ警告（月末予算超過予測）
- **概要**: 月の経過率と支出消費率を比較し、現在のペースが継続した場合の月末予測支出を計算。予算の超過が見込まれる場合に警告通知（例:「月の40%経過で予算60%消費。このペースだと月末に1.5倍超過見込み」）。
- **期待効果**: 月末ギリギリで気づくのではなく、月中盤に軌道修正が可能になる。単純な残高通知より「このままどうなるか」という予測情報を提供。
- **難易度**: 低
- **提案元**: 足軽2号

### A2-004: 前月比・年同月比支出レポート通知
- **概要**: 月次同期後（または月末）に、前月比・昨年同月比での支出増減率を計算し、カテゴリ別の増減ハイライト付きレポートをntfy通知。異常増加（+30%以上）は高優先度通知で別途アラート。
- **期待効果**: 比較分析を提供。「今月は交通費が前月比50%増」など、支出変動の原因に気づける。インフレや生活変化の影響を定量的に把握可能。
- **難易度**: 低
- **提案元**: 足軽2号
- **関連案**: A3-003（前月比グラフ表示）

### A2-005: Gmail Pub/Sub連携による即時取引検知
- **概要**: Gmail Push通知（Pub/Sub）を利用し、カード利用通知メール到着から数秒〜数十秒以内にDBへ登録・ntfy通知を実現。現状のcron定期実行（朝夕2回）より大幅に早く検知可能。
- **期待効果**: 不正利用を即座に検知し対応できる。外出先でのカード利用をリアルタイムで家族や自分に通知可能。現状は最大12時間の遅延があるが、本案ではほぼゼロ遅延。
- **難易度**: 高
- **提案元**: 足軽2号

---

## データ可視化・分析

### A3-001: 月別支出推移棒グラフ（12ヶ月）
- **概要**: 過去12ヶ月の月別合計支出を積み上げ棒グラフで表示。カード別に色分けし、月ごとの構成比も把握できる。
- **期待効果**: 「今月は先月より使いすぎているか」「どのカードの利用が増えたか」を数字の羅列ではなく視覚的に即座に判断できる。月次集計ページに追加するだけで情報密度が大幅向上する。
- **難易度**: 低
- **提案元**: 足軽3号
- **実装ヒント**: Chart.js（CDN経由）をJinja2テンプレートに埋め込み、既存の/api/summaryエンドポイントのデータを流用。追加バックエンド実装なしで実現可能。
- **関連案**: A1-001（同様の可視化提案）

### A3-002: カテゴリ別支出円グラフ（自動分類）
- **概要**: 店舗名・キーワードマッチングで取引を自動カテゴリ分類し（食費・交通・娯楽・通信等）、カテゴリ別の支出比率を円グラフで表示する。
- **期待効果**: 「月5万円のうち何に使っているか」の内訳をひと目で把握できる。家計管理の本質的な価値（支出構造の把握）を提供する。カテゴリルールはconfig.yamlに定義し、殿がカスタマイズ可能にする。
- **難易度**: 中
- **提案元**: 足軽3号
- **関連案**: A7-001（LLMによるカテゴリ分類）、G-002（カテゴリ分類エンジン戦略）

### A3-003: 前月比・前年同月比トレンドインジケーター
- **概要**: 月次集計ページの各カード・合計に対し、前月比（+/-X%、矢印↑↓）と前年同月比を数値で表示するインジケーターを追加する。
- **期待効果**: 数字を2つ見比べなくても「増えた/減った」が色と矢印で瞬時に把握できる。季節性のある支出（旅行・冠婚葬祭）も年次比較で適切に評価できる。
- **難易度**: 低
- **提案元**: 足軽3号
- **実装ヒント**: 既存のsummary APIに前月・前年同月のデータを追加返却。Jinja2テンプレートで条件付きCSS（増加=赤、減少=緑）を適用。JavaScript不要でサーバーサイド計算のみ。

### A3-004: 日別支出カレンダービュー
- **概要**: 月間カレンダー形式で各日の支出合計をヒートマップ表示。金額の大小を色の濃淡で表現し、高支出日をひと目で特定できる。
- **期待効果**: 「今月は週末にまとめて使う傾向がある」「給料日後に支出が増える」など日単位の支出パターン・習慣を発見できる。異常な高額支出日（不正利用の疑い）の視覚的早期発見にも役立つ。
- **難易度**: 中
- **提案元**: 足軽3号

### A3-005: CSVエクスポート機能
- **概要**: 取引一覧をCSV形式でダウンロードできるボタンを追加。期間・カード会社・金額範囲でフィルタしてからエクスポート可能にする。
- **期待効果**: ExcelやGoogleスプレッドシートへの持ち出しが可能になり、独自の集計・グラフ作成・確定申告用データ整理が容易になる。外部家計簿アプリ（マネーフォワード等）へのインポート素材としても使える。
- **難易度**: 低
- **提案元**: 足軽3号
- **関連案**: A1-004（UI側のエクスポートボタン）、G-003（エクスポート基盤戦略）

### A3-006: 支出TOP店舗ランキング
- **概要**: 期間内で最も利用金額が多い店舗・サービスをランキング表示。TOP10を横棒グラフで見せ、「よく行く場所」「定期課金サービス」を可視化する。
- **期待効果**: 無意識に大きな出費をしている先を発見できる。「Netflixは月額1000円だが、コーヒーショップは月2万円使っている」など節約候補を具体的に特定できる。
- **難易度**: 低
- **提案元**: 足軽3号

---

## カード対応拡充

### A4-001: セゾンカード対応パーサー追加
- **概要**: セゾンカード（クレディセゾン）の利用通知メールを解析するパーサーを追加。セゾンはポイント利用者が多く、現状5社未対応のなかで最優先候補。
- **期待効果**: セゾンカード利用者がGmail自動取込の恩恵を受けられる。既存パーサー構造を流用するため実装コストが低い。
- **難易度**: 中
- **提案元**: 足軽4号

### A4-002: PayPayカード・イオンカード対応パーサー追加
- **概要**: PayPayカード（旧Yahoo!Japanカード）およびイオンカードの利用通知メールパーサーを追加。どちらも国内利用者数トップクラスの主要カード。
- **期待効果**: 対応カード数を5社→7社へ拡大。PayPay系・イオン系利用者の支出を自動記録可能になる。
- **難易度**: 中
- **提案元**: 足軽4号

### A4-003: カード明細CSVインポート機能
- **概要**: 各カード会社のWebサイトからダウンロードできる明細CSVを取り込む機能を追加。`card-tracker import --file=明細.csv --card=saison` 形式のCLIコマンドとして実装。
- **期待効果**: Gmail連携不可カード（セゾン・オリコ等の一部メール形式）でもデータ取込が可能。過去分の一括取込にも使え、導入時の初期データ移行コストを大幅に削減できる。カード会社のCSVフォーマット差異はアダプターパターンで吸収。
- **難易度**: 中
- **提案元**: 足軽4号

### A4-004: 手動入力・既存レコード修正機能
- **概要**: CLIから支出を手動で登録・修正できるサブコマンドを追加。`card-tracker add`（新規登録）および `card-tracker edit <id>`（既存修正）を実装。現金払い・電子マネー・QR決済など、メール通知が来ない支出の記録に対応。
- **期待効果**: 現金・Suica・PayPayなどのメールなし支払いも記録可能になり、支出トラッキングの網羅性が大きく向上する。パーサー誤認識時の手動修正も可能になり、データ品質が改善される。
- **難易度**: 中
- **提案元**: 足軽4号

### A4-005: 複数Gmailアカウント対応
- **概要**: 現状は単一Googleアカウントのみ対応。複数のGmailアカウント（個人用・家族用・サブアカウント等）を設定ファイルで管理し、それぞれからカード通知メールを取得できるよう拡張。
- **期待効果**: カードごとに異なるGmailアカウントを使い分けている場合でも、一括で全カードの支出を同期できる。世帯全体の支出管理にも応用可能。
- **難易度**: 高
- **提案元**: 足軽4号

### A4-006: レシート画像・QRコードからのOCR入力
- **概要**: スマートフォンで撮影したレシート画像をOCR解析し、金額・日時・店舗名を自動抽出して登録するサブコマンドを追加。Google Cloud Vision API または Tesseract OCR を利用。`card-tracker ocr --image=receipt.jpg` 形式で呼び出す。
- **期待効果**: 現金払いやメール通知のないサービスの支出をレシートから素早く登録できる。手入力の手間を大幅に削減し、記録漏れを防止。将来的にはスマホアプリ連携にも発展可能。
- **難易度**: 高
- **提案元**: 足軽4号

---

## コード品質・テスト強化

### A5-001: Type Safety Enhancement with mypy
- **概要**: mypyの設定追加とコードベースへの型チェック導入。pyproject.tomlにmypy設定なし。現在コードベースには型ヒントが使われているが（parser.py, aggregation_service.py）、mypyによる検証がなく型エラーが見逃されている。
- **期待効果**: 型関連のバグを開発時に検出（実行時ではなく）。リファクタリング時のバグ削減。IDEオートコンプリートの精度向上。
- **難易度**: 低
- **提案元**: 足軽5号

### A5-002: Comprehensive Test Coverage for Web Routes
- **概要**: web/auth_routes.py（32%）とweb/routes.py（31%）のテストカバレッジを向上。auth_routes.py: 41ステートメント未カバー、routes.py: 160ステートメント未カバー。
- **期待効果**: テンプレートレンダリングバグ、セッションハンドリングエラー、Jinja2構文問題を本番前に検出。コアのユーザー向けコード201ステートメントをカバー。
- **難易度**: 中
- **提案元**: 足軽5号

### A5-003: Structured Logging with Log Aggregation
- **概要**: アドホックなロギングを構造化JSONログに置き換え、集約パイプラインを追加。現状30以上のモジュールのうち5つしかloggingを使用していない。フォーマットも統一されていない。
- **期待効果**: ログをプログラムで解析可能に。sync/API/CLI実行のエラーパターンを集約。異常（認証失敗の繰り返し等）を検出。運用ダッシュボードの実現。
- **難易度**: 中
- **提案元**: 足軽5号

### A5-004: Config Module Test Coverage
- **概要**: app/config.pyのユニットテスト追加（現状0%カバレッジ、16ステートメント未カバー）。環境変数のロード、デフォルト値、型変換を検証するテストを追加。
- **期待効果**: 環境変数のロード、デフォルト、型変換が正しく動作することを保証。デプロイ前の設定ミスを検出。
- **難易度**: 低
- **提案元**: 足軽5号

### A5-005: API Error Response Standardization
- **概要**: 全APIエンドポイントのエラーレスポンス形式を統一。一部はHTTPExceptionを発生させ、一部はプレーンテキストを返すなど、形式がばらばら。統一フォーマット: `{"error": str, "code": enum, "detail": str}`。
- **期待効果**: クライアントが統一的にエラーを処理できる。デバッグが容易になる。エラーシナリオのテスト追加が可能になる。
- **難易度**: 低
- **提案元**: 足軽5号

### A5-006: Database Query Performance Monitoring
- **概要**: クエリ実行時間のロギングとインデックス利用状況の分析を追加。現状クエリパフォーマンスの計測手段がない。aggregation_serviceはSQLAlchemy ORMを使用するが、EXPLAIN呼び出しなし。
- **期待効果**: UXへの影響が出る前に遅いクエリを特定。欠けているインデックスを検出。DBが拡大（1000件以上の取引）した際の月次集計クエリの性能低下を計測。
- **難易度**: 中
- **提案元**: 足軽5号

### A5-007: Input Validation Hardening with Pydantic V2 Features
- **概要**: Pydantic V2のフィールドバリデーターを活用したより堅牢なAPIリクエスト検証。プロジェクトはPydantic 2.6.0を使用しているが、スキーマは基本型のみ使用。
- **期待効果**: 無効な入力をAPI受信時に即却下。より良いエラーメッセージ。エッジケースインジェクション防止（oversized amounts、不正な日付等）。
- **難易度**: 低
- **提案元**: 足軽5号

### A5-008: Database Index Analysis and Optimization
- **概要**: 現在のインデックスを分析し、クエリパフォーマンス向上のための追加インデックスを提案。CardTransactionモデルのtransaction_dateとis_verifiedカラムはWHERE句で多用されているが、明示的なインデックス確認がない。
- **期待効果**: 月次集計クエリの高速化。/api/transactionsフィルタクエリのレイテンシ削減。同期操作時のCPU使用量低減。
- **難易度**: 低
- **提案元**: 足軽5号

### A5-009: CLI Command Error Message Improvement
- **概要**: よくあるCLI障害に対するコンテキストアウェアなエラーメッセージと提案を追加。CLI commands.pyのカバレッジは78%で47ステートメントが未カバー（多くがエラーパス）。
- **期待効果**: ユーザーが認証失敗、.env不足、DBエラーに対して実行可能な指針を得られる。サポート負荷の削減。
- **難易度**: 低
- **提案元**: 足軽5号

### A5-010: API Rate Limiting Metrics and Instrumentation
- **概要**: レートリミッターにPrometheus形式のメトリクスを追加（ヒット数、拒否数、IP別統計）。レートリミッターは存在（カバレッジ96%）するが、メトリクス出力なし。
- **期待効果**: 悪用パターンを監視。DDoSを早期検出。データに基づいてレート制限を調整。
- **難易度**: 中
- **提案元**: 足軽5号

---

## 運用・ドキュメント

### A6-001: GitHub ActionsによるCI/CDパイプライン構築
- **概要**: プルリクエスト時のテスト自動実行、マージ時のDockerイメージ自動ビルド・プッシュにより、デプロイ品質を保証。.github/workflows/に3つのワークフロー（test.yml, lint.yml, build-push.yml）を作成。
- **期待効果**: 手動テストが不要になり、デプロイまでの時間が80%削減。リグレッション発見が早期化。
- **難易度**: 中
- **提案元**: 足軽6号

### A6-002: Makefileによる開発・運用タスク自動化
- **概要**: 頻繁に使用するコマンド（テスト、ビルド、デプロイ、ログ確認）をmakeコマンドで統一、作業効率化。主要ターゲット: make install/test/lint/sync/docker-build/docker-run/docker-logs/clean/backup/help。
- **期待効果**: 開発者が覚えるべきコマンド数が50%削減。新人オンボーディング時間が短縮。
- **難易度**: 低
- **提案元**: 足軽6号

### A6-003: DevContainer設定ファイル（.devcontainer/devcontainer.json）作成
- **概要**: VS CodeやGithub Codespacesで同一開発環境を自動構築。ローカル環境汚染を防止し、チーム開発の環境差を解消。Python 3.11, ruff, pylanceを標準装備。
- **期待効果**: 新規開発者が5分で開発環境を構築可能（従来は30分以上）。環境トラブルが99%削減。
- **難易度**: 低
- **提案元**: 足軽6号

### A6-004: 運用・トラブルシューティング・ランブック（docs/runbook.md）作成
- **概要**: 日常運用時によくある問題（同期失敗、トークン期限切れ、パーサー誤動作等）の原因判定フロー・対応手順書を記載。E001〜E004の典型エラーとその対応、定期メンテナンスタスクをカバー。
- **期待効果**: 本番トラブル発生時の対応時間が70%短縮。エスカレーション前に自己解決可能な割合が80%に上昇。
- **難易度**: 低
- **提案元**: 足軽6号

### A6-005: OpenAPI/Swagger ドキュメント自動生成 & インタラクティブUI（FastAPI統合）
- **概要**: FastAPIが自動生成するOpenAPIスキーマから、インタラクティブなAPI仕様ドキュメントを利用可能に。SwaggerUI（/docs）、ReDoc（/redoc）、JSON形式（/openapi.json）へのアクセス方法を整備。
- **期待効果**: API仕様書の手動メンテが不要に。Web UI実装者がAPI動作を即座に確認可能。
- **難易度**: 低
- **提案元**: 足軽6号

---

## AI・高度技術機能

### A7-001: LLMによる取引自動カテゴリ分類
- **概要**: Claude APIを利用し、店舗名・金額・利用日時から支出カテゴリ（食費/交通費/娯楽費/日用品/医療費等）を自動分類する機能。card_transactionsテーブルにcategoryカラムを追加し、sync時にバッチ分類を実行。同一店舗のキャッシュにより2回目以降はAPI呼び出し不要。
- **期待効果**: カード会社別ではなく「カテゴリ別月間支出」が見えるようになり、「食費に使いすぎ」「娯楽費が先月比2倍」等の実用的な支出管理が可能になる。現状の根本的課題（支出の質が見えない）を解決。
- **難易度**: 中
- **提案元**: 足軽7号
- **実装ヒント**: Claude Haiku 4.5を使用（低コスト・高速）。merchant_categoriesテーブルでキャッシュ。月間APIコストは数十円レベルに抑制可能。
- **関連案**: A3-002（カテゴリ別円グラフ）、G-002（カテゴリ分類エンジン戦略）

### A7-002: 統計的異常検知による不正利用・浪費アラート
- **概要**: 過去の利用パターン（曜日別・時間帯別・店舗別の支出分布）を統計的にモデリングし、逸脱した取引をリアルタイムに検知してntfy通知する。scikit-learnのIsolationForestまたはLocalOutlierFactorを使用。
- **期待効果**: 単純な金額しきい値では検知できない異常を捕捉。「普段行かない深夜時間帯の高額利用」「普段の3倍の頻度での利用」「特定カテゴリの急増」を個人の習慣を学習した上で検知できる。
- **難易度**: 中
- **提案元**: 足軽7号

### A7-003: 自然言語クエリインターフェース（チャットbot）
- **概要**: Claude APIとFastAPIエンドポイントを組み合わせ、自然言語で支出データに問い合わせるチャットインターフェースを実装。「先月の食費いくら？」「去年と比較して」等の質問にSQLクエリを自動生成して回答。Text-to-SQL方式。
- **期待効果**: UIを操作せずとも、日本語で直感的に支出データを分析できる。「3ヶ月連続で増えてるカテゴリは？」のような複雑な分析もワンフレーズで実行可能。
- **難易度**: 高
- **提案元**: 足軽7号
- **実装ヒント**: 生成されたSQLはREAD ONLYのみ許可。1日あたりのAPI呼び出し上限をconfig.pyで管理。

### A7-004: 支出予測・パーソナライズド予算提案エンジン
- **概要**: 過去3〜6ヶ月の支出データから翌月の支出額をカテゴリ別に予測し、予算配分を自動提案。季節性（年末年始、GW等）やトレンド（漸増/漸減）を考慮した時系列予測モデルを使用。
- **期待効果**: 「来月はいくら使いそうか」の見通しが立ち、事前の予算管理が可能になる。「12月は例年支出が1.5倍になる」等の季節パターンも自動検知し、無理のない予算を提案。
- **難易度**: 高
- **提案元**: 足軽7号
- **実装ヒント**: データ量に応じてアプローチを切り替え（6ヶ月未満→移動平均、以上→Prophet）。

### A7-005: LLMフォールバック付きインテリジェントメール解析
- **概要**: 既存のregexパーサーが解析失敗またはconfidenceが低い場合に、Claude APIをフォールバックとして呼び出し、メール本文から金額・日時・店舗名を抽出する二段階パーサーアーキテクチャ。
- **期待効果**: 新フォーマットや特殊ケースに対応。カード会社がメールフォーマットを変更してもLLMが柔軟に解析。新カード会社追加時もregexパターン開発不要で即座に対応可能。
- **難易度**: 中
- **提案元**: 足軽7号
- **実装ヒント**: regex成功率が高い（現状90%+想定）ため、LLM呼び出しは月数十件程度にとどまる。

### A7-006: 支出パターンのクラスタリングと行動インサイト生成
- **概要**: 取引データをクラスタリング分析し、支出行動パターン（「平日ランチ族」「週末まとめ買い型」「衝動買い傾向」）を自動検出。月次レポートにClaude APIで生成した自然言語のインサイトコメントを付加。
- **期待効果**: 数値の羅列ではなく「あなたの支出の特徴」を言語化することで、行動変容につながる気づきを提供する。例：「今月は平日の外食が前月比40%増。特に火曜・木曜のランチが顕著です。お弁当の日を増やすと月3,000円程度の節約が見込めます。」
- **難易度**: 高
- **提案元**: 足軽7号
- **プライバシー配慮**: クラスタリングはローカル処理+Anthropic APIへは要約データのみ送信。取引生データは外部送信しない。

---

## セキュリティ・プライバシー

### A8-001: HTTPセキュリティヘッダーミドルウェア追加
- **概要**: FastAPIにStarletteミドルウェアを追加し、Content-Security-Policy、X-Frame-Options、X-Content-Type-Options、Referrer-Policy、Strict-Transport-Security等を全レスポンスに付与する。現状セキュリティヘッダーが一切設定されていない。
- **期待効果**: ブラウザ側のセキュリティ機能を活用し、XSS・クリックジャッキング・MIMEスニッフィング等を防止。CSP導入でCDN改竄時の被害も軽減。個人金融データを扱うダッシュボードの安全性が大幅向上。
- **難易度**: 低
- **提案元**: 足軽8号

### A8-002: ダッシュボード・APIへのアクセス認証導入
- **概要**: 現状、全ルート（/api/transactions、/api/sync、/dashboard等）が完全無認証で公開されている。HOST=0.0.0.0デフォルト設定と合わせ、同一ネットワーク上の誰でも金融データ閲覧・同期操作が可能。シンプルなAPIキー認証orセッションベース認証を導入。
- **期待効果**: 第三者による金融データの不正閲覧・同期操作を防止。OWASP A01（アクセス制御不備）への対応。
- **難易度**: 中
- **提案元**: 足軽8号
- **関連案**: G-001（重複: 同内容。足軽8号案を正とする）

### A8-003: トランザクションデータ保持期間ポリシー導入
- **概要**: データ保持期間（例: 13ヶ月）を設定し、期限超過レコードを自動削除するCLIコマンド（card-tracker purge --older-than 13m）とcronジョブを追加。店舗名表示時のマスキングオプションも提案。
- **期待効果**: 不要な個人金融データの蓄積を防止し、DB漏洩時の被害範囲を限定。GDPR/個人情報保護法の「必要最小限保持」原則にも適合。
- **難易度**: 中
- **提案元**: 足軽8号

### A8-004: 受信API（inbound）レートリミット導入
- **概要**: 現状、/api/sync等のエンドポイントにレートリミットがなく、無制限に同期操作を発火可能。Gmail APIクォータの枯渇やDoS攻撃のリスクがある。既存のRateLimiterクラス（outbound用）をFastAPI Dependsで受信リクエストにも適用。
- **期待効果**: Gmail APIクォータの意図しない消費を防止。外部からのDoS攻撃耐性向上。既存RateLimiterクラスの流用で実装コストも低い。
- **難易度**: 低
- **提案元**: 足軽8号

### A8-005: OAuthトークンのpickle→JSON直列化移行
- **概要**: 現状、Gmail OAuthトークンはpickle形式で暗号化保存されている（auth.py:104 pickle.loads）。pickleは任意コード実行のリスクがあり、暗号化キー漏洩時に攻撃ベクタとなりうる。google.oauth2.credentials.Credentials.to_json()/from_authorized_user_info()を使いJSON形式での直列化に移行。
- **期待効果**: pickleデシリアライズによる任意コード実行リスクを根本排除。JSON形式は人間可読でデバッグも容易。暗号化キー漏洩時の被害をトークン盗用のみに限定。
- **難易度**: 低
- **提案元**: 足軽8号

---

## 戦略・アーキテクチャ（軍師）

### G-001: APIエンドポイント認証・認可レイヤー導入
- **概要**: (重複: A8-002参照) FastAPIの全エンドポイントへのBearer Token認証またはセッションベース認証を導入。推奨: 個人利用ならAPI Key方式を先行実装（1-2時間）、将来JWT移行も視野に。
- **期待効果**: 不正アクセスによる金融データ漏洩を防止。Docker公開時やTailscale経由のリモートアクセス時にも安全にサービスを公開可能。
- **難易度**: 中
- **提案元**: 軍師

### G-002: 支出カテゴリ自動分類エンジン
- **概要**: ルールベース＋ユーザー学習型の自動分類を導入し、食費・交通・日用品等に自動タグ付け。推奨アプローチ: Phase 1: ルールベース辞書、Phase 2: ハイブリッド（LLM学習）。
- **期待効果**: 「今月食費にいくら使った？」「交通費の月推移は？」等の分析が可能になる。家計管理の本質的な価値（支出構造の可視化）を実現。
- **難易度**: 中
- **提案元**: 軍師
- **関連案**: A3-002（円グラフ可視化）、A7-001（LLMによる分類実装）

### G-003: データエクスポート・ポータビリティ基盤
- **概要**: 取引データのCSV/JSON/XLSX形式での出力と、家計簿アプリ（Zaim/MoneyForward）互換フォーマットへの変換を実装。API endpoint + CLI commandの両方で提供。
- **期待効果**: 確定申告の経費集計、家族との家計共有、他アプリへのデータ移行が容易になる。データロックインを防ぎ、ユーザーのデータ主権を確保。
- **難易度**: 低
- **提案元**: 軍師
- **関連案**: A1-004（UIエクスポートボタン）、A3-005（APIエクスポート実装）

### G-004: プラグイン型カード会社パーサーアーキテクチャ
- **概要**: 現在parser.pyは1ファイルにif/elif分岐で全カード会社の処理が集約されている。Strategy Patternで各カード会社を独立プラグインクラスに分離。推奨: abcメタクラス方式（CardParser基底クラス + 各社サブクラス）。
- **期待効果**: 新カード会社の追加がクラス1つの作成で完結し、既存コードへの影響ゼロ。テストも会社単位で独立実行可能になり、保守性が大幅向上。ロードマップB-3（パーサー精度向上）とC-1（追加カード会社）の前に実施すべき。
- **難易度**: 中
- **提案元**: 軍師

### G-005: DBスキーママイグレーション基盤（Alembic）導入
- **概要**: 現在スキーマ変更の仕組みがなく、ALTER TABLEやDB再作成が必要。Alembicを導入しバージョン管理されたマイグレーションを実現する。SQLAlchemy + Alembicは標準的な組み合わせで導入コストも低い。
- **期待効果**: カテゴリカラム追加、タグ機能、定期支出フラグ等の将来的なスキーマ拡張を安全かつ再現可能に実行できる。開発・本番環境間のスキーマ同期も容易。
- **難易度**: 低
- **提案元**: 軍師

### G-006: マルチデバイス安全アクセス戦略
- **概要**: 現在localhost:8000でのみアクセス可能。スマートフォンや外出先からの安全なアクセス手段として、VPNトンネルまたはリバースプロキシを設計する。推奨: Tailscale（ゼロコンフィグVPN、WSL2対応）。
- **期待効果**: 外出先でもスマホから支出確認が可能。「今月いくら使った？」をいつでもどこでも確認できる利便性を実現。
- **難易度**: 中
- **提案元**: 軍師
- **依存関係**: G-001（またはA8-002）のAPI認証実装が前提条件

### G-007: 長期支出トレンド分析・予測基盤
- **概要**: 現在の集計は「月別×カード会社別合計」のみ。長期的な支出トレンド分析、前年同月比較、カテゴリ別推移、予算予測機能を設計。推奨: Phase 1: SQL集計拡張（MoM/YoY）、Phase 2: Chart.jsグラフ表示。
- **期待効果**: 「先月より食費が2万円多い」「年間交通費が増加傾向」等の気づきを自動提供。データが蓄積されるほど価値が高まる、長期的な資産となる。
- **難易度**: 高
- **提案元**: 軍師
- **依存関係**: G-002（カテゴリ分類）完了後にカテゴリ別分析が可能になる

---

## 実装推奨優先順位（軍師提言）

軍師の戦略分析による実装フェーズ提言：

| フェーズ | 対象案 | 理由 |
|---------|--------|------|
| Phase 1（即時） | G-001/A8-002, G-005, G-003 | セキュリティ最優先＋低コスト高価値 |
| Phase 2（中期） | G-004, G-002, A8-001, A8-005 | 将来拡張の基盤整備 |
| Phase 3（長期） | G-006, G-007, A7-001〜A7-006 | データ蓄積後に価値顕在化するAI機能 |

---

*収集: 2026-02-20 | 足軽1号〜8号 + 軍師 | card-spending-tracker 改善案一覧*
